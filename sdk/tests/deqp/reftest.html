<html>
<head>
<script src="../resources/js-test-pre.js"></script>
<script src="../conformance/resources/webgl-test-utils.js"></script>
<script src="require.js"></script>
</head>
<body>
<div id="description"></div>
<div id="console"></div>
<canvas id="canvas" width="200" height="100"> </canvas>
<script type="text/javascript">
    var wtu = WebGLTestUtils;
    /** @type {WebGL2RenderingContext} */ var gl = wtu.create3DContext('canvas',{preserveDrawingBuffer: true}, 2);

var displayResultPane = function(id, width, height) {
    displayResultPane.counter = displayResultPane.counter || 0;
    var i = displayResultPane.counter++;
    var elem = document.getElementById(id);
    var span = document.createElement('span');
    elem.appendChild(span);
    span.innerHTML = '<table><tr><td>Result</td><td>Reference</td><td>Error mask</td></tr>' +
                            '<tr><td><canvas id="result' + i + '" width=' + width + ' height=' + height + '</td><td><canvas id="reference' + i + '" width=' + width + ' height=' + height + '</td><td><canvas id="diff' + i + '" width=' + width + ' height=' + height + '</td>' +
                     '</table>';
    var canvasResult = document.getElementById('result' + i);
    var ctxResult = canvasResult.getContext('2d');
    var canvasRef = document.getElementById('reference' + i);
    var ctxRef = canvasRef.getContext('2d');
    var canvasDiff = document.getElementById('diff' + i);
    var ctxDiff = canvasDiff.getContext('2d');
    return [ctxResult, ctxRef, ctxDiff];
};

var displayImage = function(w, h, image) {
    var createImage = function(ctx, w, h, src) {
        var imgData = ctx.createImageData(w, h);
        var index = 0;
        for (var y = 0; y < h; y++) {
            for (var x = 0; x < w; x++) {
                var offset = 4 * (y * w + x);
                for (var i = 0; i < 4; i++) {
                    imgData.data[index] = image[offset + i];
                    index = index + 1;
                }
            }
        }
        return imgData;
    };

    var contexts = displayResultPane('console', w, h);
    contexts[0].putImageData(createImage(contexts[0], w, h, image), 0, 0);
};

    requirejs([
        'framework/opengl/simplereference/sglrReferenceContext',
        'framework/common/tcuPixelFormat'
    ], function (
        sglrReferenceContext,
        tcuPixelFormat
    ) {
        try {
            console.log('Creating context');
            var limits = new sglrReferenceContext.ReferenceContextLimits(gl);
            var format = new tcuPixelFormat.PixelFormat(8,8,8,8);
            var width = 2;
            var height = 8;
            var samples = 4;
            var buffers = new sglrReferenceContext.ReferenceContextBuffers(format, 24, 8, width, height, samples);
            var ctx = new sglrReferenceContext.ReferenceContext(limits, buffers.getColorbuffer(), buffers.getDepthbuffer(), buffers.getStencilbuffer());
            console.log("Context: " + ctx);
        } catch (err) {
            console.log(err);
        }
        try {
            console.log('clear context');
            var limits = new sglrReferenceContext.ReferenceContextLimits(gl);
            var format = new tcuPixelFormat.PixelFormat(8,8,8,8);
            var width = 200;
            var height = 188;
            var samples = 4;
            var buffers = new sglrReferenceContext.ReferenceContextBuffers(format, 24, 8, width, height, samples);
            var ctx = new sglrReferenceContext.ReferenceContext(limits, buffers.getColorbuffer(), buffers.getDepthbuffer(), buffers.getStencilbuffer());
            ctx.clearColor(1, 0, 0, 1);
            ctx.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT|gl.STENCIL_BUFFER_BIT);
            var pixels = new Uint8Array(width * height * 4);
            ctx.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
            console.log("Context: " + ctx);
            console.log("Pixels: " + pixels);
            displayImage(width, height, pixels);
            ctx.scissor(width/4, height/4, width/2, height/2);
            ctx.enable(gl.SCISSOR_TEST);
            ctx.clearColor(0, 1, 1, 1);
            ctx.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT|gl.STENCIL_BUFFER_BIT);
            ctx.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
            displayImage(width, height, pixels);


        } catch (err) {
            console.log(err);
        }
        try {
            console.log('framebuffer');
            var limits = new sglrReferenceContext.ReferenceContextLimits(gl);
            var format = new tcuPixelFormat.PixelFormat(8,8,8,8);
            var width = 200;
            var height = 188;
            var samples = 4;
            var buffers = new sglrReferenceContext.ReferenceContextBuffers(format, 24, 8, width, height, samples);
            var ctx = new sglrReferenceContext.ReferenceContext(limits, buffers.getColorbuffer(), buffers.getDepthbuffer(), buffers.getStencilbuffer());
            ctx.clearColor(0, 0, 1, 1);
            ctx.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT|gl.STENCIL_BUFFER_BIT);            
            var fbo = ctx.createFramebuffer();
            var rbo = ctx.createRenderbuffer();            
            ctx.bindFramebuffer(gl.FRAMEBUFFER, fbo);
            ctx.bindRenderbuffer(gl.RENDERBUFFER, rbo);
            ctx.renderbufferStorage(gl.RENDERBUFFER, gl.RGBA8, width, height);
            ctx.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.RENDERBUFFER, rbo);
            console.log("Framebuffer status: " + (ctx.checkFramebufferStatus(gl.FRAMEBUFFER) == gl.FRAMEBUFFER_COMPLETE));
            ctx.clearColor(1, 0, 0, 1);
            ctx.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT|gl.STENCIL_BUFFER_BIT);
            var pixels = new Uint8Array(width * height * 4);
            ctx.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
            console.log("Context: " + ctx);
            console.log("Pixels: " + pixels);
            displayImage(width, height, pixels);
            ctx.scissor(width/4, height/4, width/2, height/2);
            ctx.enable(gl.SCISSOR_TEST);
            ctx.clearColor(0, 1, 1, 1);
            ctx.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT|gl.STENCIL_BUFFER_BIT);
            ctx.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
            displayImage(width, height, pixels);
            ctx.bindFramebuffer(gl.FRAMEBUFFER, null);
            ctx.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
            displayImage(width, height, pixels);
        } catch (err) {
            console.log(err);
        }
        try {
            var vertices = [
                0, 1, -1,
                -1, -1, -1,
                1, -1, -1
            ];
            var colors = [
                1
            ];
            console.log('shader');
            var limits = new sglrReferenceContext.ReferenceContextLimits(gl);
            var format = new tcuPixelFormat.PixelFormat(8,8,8,8);
            var width = 200;
            var height = 188;
            var samples = 4;
            var buffers = new sglrReferenceContext.ReferenceContextBuffers(format, 24, 8, width, height, samples);
            var ctx = new sglrReferenceContext.ReferenceContext(limits, buffers.getColorbuffer(), buffers.getDepthbuffer(), buffers.getStencilbuffer());
            ctx.clearColor(0, 0, 1, 1);
            ctx.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT|gl.STENCIL_BUFFER_BIT);
            var fbo = ctx.createFramebuffer();
            var rbo = ctx.createRenderbuffer();
            ctx.bindFramebuffer(gl.FRAMEBUFFER, fbo);
            ctx.bindRenderbuffer(gl.RENDERBUFFER, rbo);
            ctx.renderbufferStorage(gl.RENDERBUFFER, gl.RGBA8, width, height);
            ctx.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.RENDERBUFFER, rbo);
            console.log("Framebuffer status: " + (ctx.checkFramebufferStatus(gl.FRAMEBUFFER) == gl.FRAMEBUFFER_COMPLETE));
            ctx.clearColor(1, 0, 0, 1);
            ctx.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT|gl.STENCIL_BUFFER_BIT);
            var pixels = new Uint8Array(width * height * 4);
            ctx.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
            console.log("Context: " + ctx);
            console.log("Pixels: " + pixels);
            displayImage(width, height, pixels);
            ctx.scissor(width/4, height/4, width/2, height/2);
            ctx.enable(gl.SCISSOR_TEST);
            ctx.clearColor(0, 1, 1, 1);
            ctx.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT|gl.STENCIL_BUFFER_BIT);
            ctx.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
            displayImage(width, height, pixels);
            ctx.bindFramebuffer(gl.FRAMEBUFFER, null);
            ctx.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
            displayImage(width, height, pixels);
        } catch (err) {
            console.log(err);
        }

    });

</script>

</body>
</html>